{% extends 'base.html' %}

{% load static %}
{% block content %}
{% csrf_token %}

<!-- Main Section Start -->
<div class="main-section pt-5">
    <div class="page-section">
        <div class="container">
            <div class="row">
                
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
                    <div class="tabs-holder horizontal">
                        <ul class="stickynav-tabs nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#home"><i class="fa fa-shopping-cart text-danger"></i>Review Your Billing Address</a></li>
                            
                        </ul>
                        <div class="tab-content">
                            <div id="home" class="tab-pane in active">
                                <div class="menu-itam-holder">
                                    
                                    <div id="menu-item-list-6272" class="menu-itam-list">
                                        
                                        <div class="billing-address">
                                            <div><b>{{ order.name }}</b></div>
                                            <div>{{ order.address }}</div>
                                            <div>{{ order.city }} - {{ order.pin_code }}</div>
                                            <div>{{ order.state }}, {{ order.country }}</div>
                                            <div><b>Phone: </b>{{ order.phone }}</div>
                                            <div><b>Email: </b>{{ order.email }}</div>
                                            <div><b>Payment: </b>{{ order.payment_method }}</div>
                                            <br>
                                            <div><a href="{% url 'checkout' %}" class="btn btn-outline-danger">Edit</a></div>
                                            <br>

                                        </div>
                                        
                                    </div>

                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>

                <!-- Your order section -->
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                    <div class="tabs-holder horizontal">
                        <ul class="stickynav-tabs nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#home"><i class="icon- icon-room_service"></i>Your Order</a></li>
                            
                        </ul>
                        <div class="tab-content">
                            <div id="home" class="tab-pane in active">
                                <div class="menu-itam-holder">
                                    
                                    <div>

                                        <table class="table">
                                            <tbody>
                                                {% for item in cart_items %}
                                                <tr>
                                                    <td><img src="{{ item.fooditem.image.url }}" width="40" alt="Food Image"></td>
                                                    <td><b>{{ item.fooditem }}</b></td>
                                                    <td>{{ item.quantity }}</td>
                                                    <td>${{ item.fooditem.price }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>

                                        <ul>
                                            <li style="list-style-type: none;">
                                                Subtotal
                                                <span class="price float-right">
                                                    <span class="currency">$</span>
                                                    <span id="subtotal">{{ subtotal }}</span>
                                                </span>
                                            </li>

                                            {% for key, value in tax_dict.items %}
                                                {% for i, j in value.items %}
                                                    <li style="list-style-type: none;">
                                                        {{ key }} <small>({{ i }}%)</small>
                                                        <span class="price float-right">
                                                            <span class="currency">$</span>
                                                            <span id="tax-{{ key }}">{{ j }}</span>
                                                        </span>
                                                    </li>
                                                {% endfor %}
                                            {% endfor %}


                                            <li style="list-style-type: none; font-weight: 600;">
                                                TOTAL
                                                <span class="price float-right">
                                                    <span class="currency">$</span>
                                                    <span id="total">{{ grand_total }}</span>
                                                </span>
                                            </li>
                                            <!-- Only display the selected payment method in the summary (already shown as {{ order.payment_method }}) -->
                                            <!-- Keep the 'Complete Payment' button for finalizing payment. -->
                                            <div style="margin: 10px 0;">
                                                <button id="complete-payment-btn" style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px;">
                                                    âœ“ Complete Payment
                                                </button>
                                            </div>
                                            <!-- RazorPay Button (Keep for future use) -->
                                            <div id="rzp_payment_button" style="display: none;">
                                                <button class="btn btn-danger w-100 p-2" id="rzp-button1">Pay with RazorPay</button>
                                                <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
                                            </div>
                                        </ul>
                                    </div>
                                    
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>
<!-- Main Section End -->


<script>
    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
                }
            }
        }
        return cookieValue;
    }
    

    var grand_total = "{{ grand_total }}"
    var url = "{% url 'payments' %}"
    var order_number = "{{ order.order_number }}"

    // Try multiple methods to get CSRF token
    let csrftoken = getCookie('csrftoken');
    if (!csrftoken) {
        csrftoken = '{{ csrf_token }}';
    }
    if (!csrftoken) {
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            csrftoken = csrfInput.value;
        }
    }
    
    var order_complete = "{% url 'order_complete' %}"
    
    console.log('=== PAYMENT DEBUG INFO ===');
    console.log('Grand Total:', grand_total);
    console.log('Order Number:', order_number);
    console.log('Payment URL:', url);
    console.log('CSRF Token:', csrftoken);
    console.log('Payment Method from Order:', "{{ order.payment_method }}");
    console.log('PayPal Client ID:', "{{ PAYPAL_CLIENT_ID }}");
    console.log('PayPal Client ID length:', "{{ PAYPAL_CLIENT_ID }}".length);
    console.log('PayPal SDK Available:', typeof paypal !== 'undefined');
    console.log('PayPal Button Container Exists:', document.getElementById('paypal-button-container') !== null);
    
    // Check if PayPal payment method is selected
    console.log('Current payment method: {{ order.payment_method }}');
    console.log('PayPal SDK disabled for testing - using manual payment only');
    
    // Disable PayPal SDK rendering to prevent interference with manual button
    /*
    // Render the PayPal button into #paypal-button-container
    if (typeof paypal !== 'undefined') {
        let paymentInProgress = false; // Prevent double payments
        console.log('PayPal SDK loaded successfully - creating buttons');
        
        // Clear the loading message
        document.getElementById('paypal-button-container').innerHTML = '';
        
        paypal.Buttons({
            // Set up the transaction
            createOrder: function(data, actions) {
                if (paymentInProgress) {
                    console.log('Payment already in progress, preventing duplicate');
                    return false;
                }
                
                console.log('Creating PayPal order with amount:', grand_total);
                paymentInProgress = true;
                
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: grand_total
                        }
                    }]
                });
            },

            // Finalize the transaction
            onApprove: function(data, actions) {
                console.log('PayPal payment approved:', data);
                
                // Disable the PayPal button container to prevent multiple clicks
                const element = document.getElementById('paypal-button-container');
                element.style.pointerEvents = 'none';
                element.innerHTML = '<h4 class="text-center"><i class="fa fa-spinner fa-spin"></i> Processing payment...</h4>';
                
                return actions.order.capture().then(function(orderData) {
                    // Successful capture! For demo purposes:
                    console.log('PayPal order captured:', orderData);
                    var transaction = orderData.purchase_units[0].payments.captures[0];

                    var transaction_id = transaction.id;
                    // Use transaction status for more accurate status reporting
                    var status = transaction.status; // This will be 'COMPLETED' for successful payments
                    var payment_method = 'PayPal';
                    
                    console.log('Sending transaction data:', {
                        transaction_id: transaction_id, 
                        payment_method: payment_method, 
                        status: status,
                        orderData_status: orderData.status,
                        transaction_status: transaction.status
                    });
                    
                    // Add try-catch around sendTransaction call
                    try {
                        console.log('Calling sendTransaction...');
                        sendTransaction(transaction_id, payment_method, status);
                    } catch (error) {
                        console.error('Error calling sendTransaction:', error);
                    }
                });
            },
            
            // Handle errors
            onError: function(err) {
                console.error('PayPal error:', err);
                paymentInProgress = false; // Reset flag on error
                swal("Payment Failed", "PayPal payment failed. Please try again.", "error");
            },
            
            // Handle cancellation
            onCancel: function(data) {
                console.log('PayPal payment cancelled:', data);
                paymentInProgress = false; // Reset flag on cancellation
                swal("Payment Cancelled", "PayPal payment was cancelled.", "info");
            }

        }).render('#paypal-button-container');
    } else {
        console.error('PayPal SDK not loaded');
        document.getElementById('paypal-button-container').innerHTML = '<p style="color:red; text-align: center;">PayPal SDK failed to load. Please refresh the page.</p>';
    }
    */

    // PayPal SDK disabled for testing - using manual payment button instead
    console.log('PayPal SDK integration commented out for testing');

    // Send the data to payments view to store in the database
    function sendTransaction(transaction_id, payment_method, status) {
        console.log('Starting sendTransaction with:', {
            transaction_id: transaction_id,
            payment_method: payment_method, 
            status: status,
            order_number: order_number,
            url: url
        });
        
        // Strengthened validation for all required fields
        if (!transaction_id || !payment_method || !status || !order_number || !url) {
            console.error('=== MISSING REQUIRED DATA ===');
            console.error('transaction_id:', transaction_id);
            console.error('payment_method:', payment_method);
            console.error('status:', status);
            console.error('order_number:', order_number);
            console.error('url:', url);
            swal("Payment Error", "Missing required payment data. Please try again.", "error");
            return;
        }
        
        $.ajax({
            type: 'POST',
            url: url,
            timeout: 30000,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: {
                'order_number': order_number,
                'transaction_id': transaction_id,
                'payment_method': payment_method,
                'status': status
            },
            beforeSend: function(xhr, settings) {
                console.log('AJAX beforeSend triggered');
                console.log('Request URL:', settings.url);
                console.log('Request data:', settings.data);
            },
            success: function(response) {
                console.log('=== PAYMENT RESPONSE RECEIVED ===');
                console.log('Full response object:', response);
                console.log('Response type:', typeof response);
                console.log('Response.success:', response.success);
                console.log('Response.error:', response.error);
                console.log('Response.order_number:', response.order_number);
                console.log('Response.message:', response.message);
                
                // Check if response indicates an error first
                if (response.error) {
                    console.error('Payment processing failed:', response.error);
                    swal("Payment Error", response.message || 'Payment processing failed', "error");
                    const element = document.getElementById('paypal-button-container');
                    if (element) {
                        element.style.pointerEvents = 'auto';
                        location.reload();
                    }
                    return;
                }
                
                // Only redirect if both response.success and response.order_number are present
                if (response.success && response.order_number) {
                    console.log('Payment successful! Showing success message');
                    var redirectUrl = order_complete + '?order_no=' + response.order_number + '&trans_id=' + response.transaction_id;
                    console.log('Redirect URL will be:', redirectUrl);
                    
                    // Show success message and redirect
                    console.log('About to show SweetAlert and redirect...');
                    
                    // First, try immediate redirect
                    console.log('Attempting immediate redirect to:', redirectUrl);
                    window.location.href = redirectUrl;
                    
                    // Also show SweetAlert as backup
                    swal("Payment Successful!", "Your order has been placed successfully. Order ID: " + response.order_number, "success")
                    .then(function() {
                        console.log('SweetAlert closed, redirect should have already happened');
                    })
                    .catch(function() {
                        console.log('SweetAlert failed, but redirect should have already happened');
                    });
                } else {
                    console.error('Unexpected response format or missing order_number:', response);
                    swal("Payment Error", "Received unexpected response from server. Please contact support.", "error");
                    const element = document.getElementById('paypal-button-container');
                    if (element) {
                        element.style.pointerEvents = 'auto';
                        location.reload();
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('=== AJAX ERROR OCCURRED ===');
                console.error('XHR status:', xhr.status);
                console.error('XHR statusText:', xhr.statusText);
                console.error('XHR responseText:', xhr.responseText);
                console.error('Error status:', status);
                console.error('Error thrown:', error);
                console.error('Full XHR object:', xhr);
                
                // Try to parse the response if it's JSON
                let errorMessage = "There was an error processing your payment. Check console for details.";
                try {
                    const responseJson = JSON.parse(xhr.responseText);
                    if (responseJson.message) {
                        errorMessage = responseJson.message;
                    }
                    console.error('Parsed error response:', responseJson);
                } catch (e) {
                    console.error('Could not parse error response as JSON');
                }
                
                swal("Payment Error", errorMessage, "error");
                
                const element = document.getElementById('paypal-button-container');
                if (element) {
                    element.style.pointerEvents = 'auto';
                    location.reload();
                }
            },
            complete: function(xhr, status) {
                console.log('AJAX COMPLETE - Status:', status);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
      var completeBtn = document.getElementById('complete-payment-btn');
      if (completeBtn) {
        completeBtn.addEventListener('click', function() {
          // Get selected payment method
          var method = document.querySelector('input[name="payment_method"]:checked');
          var paymentMethod = method ? method.value : 'Unknown';
          // Generate a mock transaction ID
          var transactionId = 'TXN_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

          if (!order_number || order_number === 'None' || order_number.trim() === '') {
            swal('Payment Error', 'Order number is missing. Please try again.', 'error');
            return;
          }
          // Call sendTransaction
          sendTransaction(transactionId, paymentMethod, 'COMPLETED');
        });
      }
    });
</script>
{% endblock %}